clc;
clear;
close all;

%% optimize
% optimize the initial conditions and controller hyper parameters
q0 = [-pi/9; pi/9; 0];
dq0 = [1.5; 0.7; 0.5]; 
x0 = [q0; dq0; control_hyper_parameters()];

std = 0.07;
disturbance_list = normrnd(0,std,1,100);
% disturbance_list = zeros(size(disturbance_list));
target_velocity = 0.4;
w1 = 0; %weigth for target velocity
w2 = 0; %weigth for CoT
w3 = 1; %weigth for distance
w4 = 0; %weigth for stepLength
w5 = 0; %weigth for stepFrequency
%%
% rng default
% gs = GlobalSearch;
% sixmin = @(x) optimziation_fun(x,target_velocity, [w1 w2 w3 w4 w5], disturbance_list);
% problem = createOptimProblem('fmincon', 'x0', x0, 'objective', sixmin);
% [xf, FVAL] = run(gs, problem);

%% simulate solution
% 
% % extract parameters
% q0 = xf(1:3);
% dq0 = xf(4:6);
% x_opt = xf(7:end);
%%
q0 = [-0.367398550343904;0.302389612572914;-0.034893343912364];
dq0 = [1.479251815241635;0.671188992699078;0.470418776851204];
x_opt = [99.999397138911720;99.999535218056300;99.999302303901400;0.322662499736999;-0.267431047273216;0.004895439363258;0.145023635939721;99.999761979363240;-0.218653266810658];


% simulate
num_steps = 30;
sln = solve_eqns(q0, dq0, num_steps, x_opt, disturbance_list);
%%
animate(sln, x_opt);
%%
% results = analyse(sln, x_opt, true);

%% Solutions
% V mean = 0.6
% [1.000329776007385e+02;1.001334701604554e+02;99.978713098327900;0.353741095790404;-0.349260041082283;-1.957509744040651e-06;0.174436194509077;1.001201908656399e+02;-0.261664522272110]

% Very nice
% q0 = [-0.342555017730019;0.354681985323615;-2.628413132584730e-05]
% dq0 = [1.543739914703585;0.711211464474537;0.508413571608694]
% [1.015179601122004e+02;1.022909575057120e+02;1.001526396217980e+02;0.344114369216307;-0.348448265122705;6.338509740212456e-05;0.174193827086008;98.596879193167520;-0.259122965797613]

% min velocity only 0.4 ==> achieve 0.73
% [99.999974515439150;99.999970530822540;99.999983022366520;0.348882279588832;-0.345792763211055;-0.002824592462120;0.172873034856167;99.999983165998510;-0.259591112907350]

% max distance 2.1824
% q0 = [-0.367398550343904;0.302389612572914;-0.034893343912364]
% dq0 = [1.479251815241635;0.671188992699078;0.470418776851204]
% [99.999397138911720;99.999535218056300;99.999302303901400;0.322662499736999;-0.267431047273216;0.004895439363258;0.145023635939721;99.999761979363240;-0.218653266810658]

sigma_q = [0.2,0.09,0.07];
sigma_qd = [9.9,1.3,1.9];
F_h_d = [-29, 102];