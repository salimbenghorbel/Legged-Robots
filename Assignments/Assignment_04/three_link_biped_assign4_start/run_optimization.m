clc;
clear;
close all;

%% optimize
% optimize the initial conditions and controller hyper parameters
q0 = [pi/9; -pi/9; 0];
dq0 = [0; 0; 8]; 
x0 = [q0; dq0; control_hyper_parameters()];

target_velocity = 0.6;
w1 = 1; %weigth for target velocity
w2 = 0; %weigth for CoT
w3 = 0; %weigth for distance

% use fminsearch and optimset to control the MaxIter
[xf, FVAL] = fminsearch(@(x) optimziation_fun(x,target_velocity, [w1 w2 w3]), x0);

%% simulate solution

% extract parameters
q0 = xf(1:3);
dq0 = xf(4:6);
x_opt = xf(7:end);

% simulate
num_steps = 10;
sln = solve_eqns(q0, dq0, num_steps, x_opt);
animate(sln);
results = analyse(sln, x_opt, true);

%% Solutions
% target_velocity = 0.05 %w1=1
% q0 = [0.280819906569514;-0.431357611854037;3.323567773506669e-04]
% dq0 = [2.063214489147858e-04;0.001368575117797;8.731879505774163]
% x = [4.529354032517039e+02;2.198384586167352e+02;68.780511171806210;6.281590173932947;0.004256353832164]

% target_velocity = 0.2 %w1=1
% q0 = [0.297318111854237;-0.412897949238112;1.596675397954608e-04]
% dq0 = [-1.450226635671410e-05;9.288792599847756e-04;8.452911207367773]
% x = [473.066272305925;204.151836583954;68.4847747835418;6.07883827739157;0.0534951208949030]

% target_velocity = 0.4 %w1=1
% q0 = [0.308933221524628;-0.405235552468958;1.469426529063043e-04]
% dq0 = [8.910686991507456e-05;7.162778739516522e-04;8.201323568453173]
% x = [4.660268461184289e+02;2.018804028184798e+02;70.351590598420760;5.926887464221797;0.069203687127125]

% target_velocity = 0.6 %w1=1
% q0 = [0.326585295662528;-0.387793585201497;1.278664999243470e-04]
% dq0 = [3.858829673116224e-05;4.127910465349751e-04;7.931658654424570]
% x = [4.742132793264540e+02;1.854328424293119e+02;71.555553573067750;5.656400262794028;0.112639299299701]

% target_velocity = 0.2 %w1=1 w2=0.5
% q0 = [0.390459298077669;-0.385319039681763;-0.001707673721874]
% dq0 = [0.001840376951722;-0.001938591966529;6.922662689686295]
% x = [4.463124429770371e+02;2.565219202553469e+02;70.691178008580640;5.734544267198942;0.131466192042610]

% target_velocity = 0.4 %w1=1 w2=0.5
% q0 = [0.390459298077669;-0.385319039681763;-0.001707673721874]
% dq0 = [0.001840376951722;-0.001938591966529;6.922662689686295]
% x = [4.463124429770371e+02;2.565219202553469e+02;70.691178008580640;5.734544267198942;0.131466192042610]

% max distance
% q0 = [0.311287756607249;-0.321311734764443;-9.554912542886866e-04]
% dq0 = [-1.807494066540981e-04;-6.063797793353278e-04;8.846742208226466]
% x = [3.999556150288952e+02;1.830811409967079e+02;86.723279526266570;5.175305737025910;0.231333431177886]

% simulate
% num_steps = 10;
% sln = solve_eqns(q0, dq0, num_steps, x);
% animate(sln);
% results = analyse(sln, x, true);